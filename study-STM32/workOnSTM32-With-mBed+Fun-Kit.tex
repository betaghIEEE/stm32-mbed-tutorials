% !TEX TS-program = xelatex
%
% Created by Daniel Beatty on 2020-09-25.
% Copyright (c) 2020 All Night Star Party.
\documentclass{article}

\usepackage{polyglossia}
\usepackage{hyperref}

\hypersetup
{
  pdftitle   = {Working Electrical Engineering Projects with STM32 + Fun Kit},
  pdfsubject = {Electrical Engineering, Computer Science, Embedded Computing},
  pdfauthor  = {Daniel Beatty}
}

\title{Working Electrical Engineering Projects with STM32 + Fun Kit}
\author{Daniel Beatty}

\begin{document}

\maketitle

\begin{abstract}
    Abstract
\end{abstract}

\section{Introduction}


Why am I doing this?  I have some examples provided by a client of mine.  These might have worked in some STM32 development environments.  However, software evolves to meet hardware and security needs.  I suspect that I am not alone.  

I would prefer to have a cross platform means to develop software. I would prefer the ability to analyze the kernels deployed on these devices.  I would like to ensure that I can deliver a good product, and apply micro and macro architectures (aka design patterns) as well good algorithms.  

So, I want to know how this mBed system work.  I will start with the STM32 product line to develop this micro-architecture approach.  

I plan to demostrate these techiniques on MacOS, Windows, and Linux (ARM).

\newpage
\section{The Base Line Integrated Development Environment Part 1} % (fold)
\label{sec:the_base_line_integrated_development_environment_part_1}

The Eclipse Foundation and Advanced RISC Machines(ARM) consortium work together to produce an Integrated Development Environment(IDE)\footnote{https://os.mbed.com} to fulfill needs of micro-controller developers.  The development community needs build services and IDE systems to handle the complex builds. %that include the real-time operating system (RTOS) itself and supplimental main purpose software.  %This capability follows in the footsteps of many micro-controllers that came before, and enables a new generation of makers.

The Advanced RISC Machines (ARM) Limited developed the mBedOS to exhibit standard features amongst various manufactures builds.  Thus, I can develop a simple program and compile it for many different boards, and it still works. 

Mbed Studios (a modified Eclipse Theia) released in June 2019.  It is derived from the Eclipse `Theia' line shown in a YouTube video\footnote{https://www.youtube.com/watch?v=HsTtzqL-GP8}.

ARM made the mBed Suite \footnote{https://os.mbed.com/studio/} based on Eclipse Theia  \footnote{https://youtu.be/NLkQzx6rrnU \\https://www.youtube.com/channel/UCXu7pV552EkR99mCzjwGvTQ/featured}.  This IDE supports inclusion of the mBed OS itself in a build and any additional libraries required to construct a software product for the ARM based boards.  These libraries include:
\begin{itemize}
	\item `Tiny interactions'
	\item Communication mechanisms
	\item Hardware Abstraction Layer(s)
\end{itemize}



ARM supplies a tutorial on installing the mBed Theia environment on MS Windows 10\footnote{https://os.mbed.com/teams/ST-Americas-mbed-Team/wiki/Getting-Started-with-mbed-and-the-STM32F}.  We will examine Mac and Windows on Intel processor machines.   For example, I develop embedded software on a MacBook Pro and also demonstrate with a Mac Min running MS Windows with bootcamp.  This work also seeks to produce Raspberry Pi and iPad tools to augment the STM Micro-controllers.  %\textbf{I} will also attempt to set up the mBed Studio on a Raspberry Pi.   What would be useful is to establish a Jenkins + Version control + Testing + Distribution suite for these applications.  


\subsection{ST Microelectronics Libraries} % (fold)
\label{sub:st_microelectronics_libraries}

ST Microelectronics started as a French company.  It operates out of many nations.  In addition to producing the micro-controller boards themselves, they also produce support libaries for their boards\footnote{http://www.emcu.it/STM32F4xx/STM32F4-Library/STM32F4-Library.html}.  For example, ST Microelectronics is not the first manufacturer to produce ARM based digital signal processor (DSP)\footnote{https://www.st.com/content/st\_com/en/products/embedded-software/mcu-mpu-embedded-software/stm32-embedded-software/stm32-standard-peripheral-libraries/stsw-stm32065.html}.  DSP engines provide a similar acceleration to vector / array math operations that a graphics processor units (GPU) provides to two and three dimensional arrays.   In some cases, GPU systems provide the DSP and general purpose accelerated capabilities all in one facility. 






% subsection st_microelectronics_libraries (end)

\subsection{Hardware Abstraction Layer(s)} % (fold)
\label{sub:hardware_abstraction_layer_s}

ST Microelectroincs and mbedOS supplies Hardware Abstraction Layer(s) to access key MCU capabilites.  The mbedOS is not the only real time operating system (RTOS) for micro-controllers.  ARM's mbedOS does support many implementations of its chip set \footnote{https://os.mbed.com/questions/53876/CMSIS-vs-STM32CUBEHAL-vs-MBED/} and builds into a tidy size for each set it supports.




The mBed website carries white paper references for each of the boards it supports.  For example, this piece focuses on the Nucleo-F413ZH\footnote{https://os.mbed.com/platforms/ST-Nucleo-F413ZH/}.  This platform and others can be found at \footnote{https://os.mbed.com/platforms/}.
Alternative cards include:
\begin{itemize}
	\item Discovery F413H \footnote{https://os.mbed.com/platforms/ST-Discovery-F413H/}
	\item Nucleo L4R5ZI-P \footnote{https://os.mbed.com/platforms/ST-Nucleo-L4R5ZI-P/}
	\item Nucleo WB55RG \footnote{https://os.mbed.com/platforms/ST-Nucleo-WB55RG/}
\end{itemize}

Some of the main library sources from STM are provided on the STM32f4 Discovery web site\footnote{http://stm32f4-discovery.net/2014/05/all-stm32f429-libraries-at-one-place/} forum.  

%The Nucleo-F413ZH does not have a direct ethernet connection, but resources like this GitHub repository \footnote{https://github.com/khoih-prog/EthernetWebServer\_STM32/tree/master/src/detail} suggest that there are ways to make it work.

% subsection hardware_abstraction_layer_s (end)

\subsection{It is about the Libraries, Shhsss.} % (fold)
\label{sub:it_is_about_the_libraries_shhsss}

For any task associated with a micro-controller, ARM based micro-controllers require the libraries.  ARM micro-controllers require the frameworks of the RTOS itself, in this case mBedOS.  

Developers refactor their code as they get into development.  These libraries serve as building blocks.  This product explores basic library creation to benefit fellow developers and makers of products.

As we create libraries and programs, it behoves us to consider license programs and how to market our productions.  We want the fruits of our labor to bring us profit.  It might if we can attract people to use it and honor our contributions.  It certainly won't if we hoard it or never make it.  

So we explore creating programs, importing existing libraries, and creating new libraries.  Documentation of such products contributes to fellow makers utilizing our work to make things and solving problems.  We make money from establishing those connections and making the software that provide things their connection to real life.

\subsubsection{Create a Repository} % (fold)
\label{ssub:create_a_repository}

We present software creation from a independent producers point of view.  Many corporations and government entities insist on their own repository tools.  For these entities, we can comprehend the need of such restrictions.  They have assests to protect and the finances to provide on property protection.  

% subsubsection create_a_repository (end)

\subsubsection{Creating A Program} % (fold)
\label{ssub:creating_a_program}
The mBed Suite documentation provides an excellent how-to guide on creating a program \footnote{https://os.mbed.com/docs/mbed-studio/current/create-import/index.html}.   This process works out in a very straight forward way.  



% subsubsection creating_a_program (end)

\subsubsection{Importing A Program} % (fold)
\label{ssub:importing_a_program}

% subsubsection importing_a_program (end)

\subsubsection{Importing Libraries} % (fold)
\label{ssub:importing_libraries}


\footnote{https://os.mbed.com/docs/mbed-studio/current/manage-libraries/index.html#importing-a-library}

% subsubsection importing_libraries (end)

\subsubsection{Creating Libraries} % (fold)
\label{ssub:creating_libraries}

% subsubsection creating_libraries (end)


% subsection it_is_about_the_libraries_shhsss (end)


% section the_base_line_integrated_development_environment_part_1 (end)



\section{Basic Hard Tools} % (fold)
\label{sec:basic_hard_tools}

\subsection{Work on Timer} % (fold)
\label{sub:work_on_timer}

In cases where we ask the process to wait, we should ensure that the I/O pipe empties.  Otherwise, we have no idea when this process takes place.  It can occur in the wrong times.

There are third party USB drivers such as \footnote{https://os.mbed.com/users/gte1/code/STM32\_USBDevice/}.

Also, the timer's have issue with floating point numbers.

Lastly, the STDIO has trouble with printing floats.   

% subsection work_on_timer (end)

\subsection{Flushing The Standard Input Output} % (fold)
\label{sub:flushing_the_standard_input_output}

% subsection flushing_the_standard_input_output (end)


\subsection{Blinky} % (fold)
\label{sub:blinky}


This is a basic hello world type program.  A programmer can build this blinky world program for the on board LED or a circuit example.

% subsection blinky (end)

\subsection{Eight Bit Shift Register} % (fold)
\label{sub:eight_bit_shift_register}


Eight bit Shifter IC 74HC595 

% subsection eight_bit_shift_register (end)

% section basic_hard_tools (end)


\section{Analog to Digital Conversion} % (fold)
\label{sec:analog_to_digital_conversion}

\subsection{Simple Analog In - Voltmeter} % (fold)
\label{sub:simple_analog_in_voltmeter}


The terms simple and analog rare work together in practice.  This work shows examples to highlight how the analog to digital converter (ADC) works,  distinction when an optical isolator, and safety mechanisms to protect your micro-controller from damage.

%We can make a simple analog example using the parts in the Fun Kit.   We design the circuit to have very little current.  

I learned to look up the pin name and its location on the board.   There pin names that don't necessarily correspond to the label next pin itself.  The A0 pin on the CN9 pin set is actually PA\_3.  It is easy to make the mistake in calling this pin PA\_0.   This distinction can lead to massive mistakes and cause to operate the board in a wrong manner.  

To demonstrate simple ADC in, I use a simple voltage divider circuit with three resistors.  Voltage is proportial to resistance.  Therefore, we can measure voltage across a resistor and expect its value.  That proportion should change if we can the resistance of one of the other resistors.  

Therefore, I establish this measurement across a constant 330 $\omega$ resistor.  Then, I do similar across a 330 $\omega$ potentiometer.  We see the voltage go from $V_{in}$.  This helps establish a baseline for comparing the ADC readings.   

I built the circuit with parts acquired from \footnote{http://www.rexqualis.com/products/}.  The fun kit \footnote{http://www.rexqualis.com/product/electronics-component-fun-kit-w-power-supply-module-male-to-female-jumper-wire-830-tie-points-breadboard-precision-potentiometer-resistor-for-arduino-raspberry-pi-stm32/} 
provides many of the resistors I need.   The UNO Project starter \footnote{http://www.rexqualis.com/product/uno-project-super-starter-kit-for-arduino-w-uno-r3-development-board-detailed-tutorial/} provides some addition parts that I can use later.  Also the UNO Project starter provides a Arduino UNO that I can use for comparison.  Lastly, I used some competitor products to provide the potentiometers and inductors that I need for future examples.  


Also, it is important to note a fix on stdio.  Mbed.os by default turns off floating point parameters in stdio/UART\footnote{https://github.com/ARMmbed/mbed-os/blob/master/platform/source/minimal-printf/README.md}.  
There is a parameter in platform/mbed\_app.json.  By default, a new mbed project has the value for `minimum-printf-enable-floating-point' set to false.  In order to print out floating point, this value needs to be set to true.  

With this, we can see in the example that the voltage read from the potenimeter is pretty close to what a common multimeter reads.  There are adjustment factors that we apply to give a rough calibration.  For production, it would help to obtain a more calibrated set of values.  

We see a similar case with thermister based thermometers.  I set up a simple $330\omega$ resistor in series with a thermister out of the fun kit.  Here we can measure the voltage across the thermister.  We then can measure ratios and offsets for temperature.  
\begin{equation}
	T = \frac{(mV - 225.0)}{10.0}
\end{equation}

% subsection simple_analog_in_voltmeter (end)


\subsection{Change Flashing Rate with Potentiometer} % (fold)
\label{sub:change_flashing_rate_with_potentiometer}



% subsection change_flashing_rate_with_potentiometer (end)

\subsection{Thermostat} % (fold)
\label{sub:thermostat}

% subsection thermostat (end)

\subsection{Light Meter} % (fold)
\label{sub:light_meter}

% subsection light_meter (end)

\subsection{Thermo-resistor -Taking the Temperature} % (fold)
\label{sub:thermo_resistor_taking_the_temperature}

This is an example of an Analog in problem


% subsection thermo_resistor_taking_the_temperature (end)

\subsection{Sound Level Meter} % (fold)
\label{sub:sound_level_meter}

% subsection sound_level_meter (end)


% section analog_to_digital_conversion (end)


\section{Analog Out} % (fold)
\label{sec:analog_out}

\subsection{Fixed Voltage} % (fold)
\label{sub:fixed_voltage}

% subsection fixed_voltage (end)

\subsection{Sawtooth} % (fold)
\label{sub:sawtooth}

% subsection sawtooth (end)

\subsection{Sine Wave Generator} % (fold)
\label{sub:sine_wave_generator}

% subsection sine_wave_generator (end)


\subsection{Combining the Capabilites of Each Wave Generator Type} % (fold)
\label{sub:combining_the_capabilites_of_each_wave_generator_type}

% subsection combining_the_capabilites_of_each_wave_generator_type (end)

\subsection{Buzzer Fun} % (fold)
\label{sub:buzzer_fun}

% subsection buzzer_fun (end)

\subsection{Pulse Width Modulated Buzzers} % (fold)
\label{sub:pulse_width_modulated_buzzers}

% subsection pulse_width_modulated_buzzers (end)

% section analog_out (end)


\section{Optical Isolation} % (fold)
\label{sec:optical_isolation}

I remember a lesson from my embedded computing class back in the Spring of 1998.  Professors Darrel Vines, Michael Parton, and Mike Giesselman told us over and over about the importance of optical isolation.  These professors worked in pulsed power, and I wish I had the wisdom back then to realize just how important this subject is.  % and literally how much power goes into such devices.  

Pulsed Power delivers a large amount of current in a very short space and time.  The amount of current involved can easily melt a microcontroller and destroy it.  Yet, these controllers are essential in regulating such power elements to fulfill their purpose.  

The fun kit comes with a 4N35 white paper can be found at\footnote{https://www.digchip.com/datasheets/parts/datasheet/161/4N35-pdf.php}. The inputs on pins 1 and 2 can be thought of as in and out for a light emitting diode (LED).  The light from the LED feeds a photo-transistor that can handle much higher currents. 

% section optical_isolation (end)

\section{Transistor Circuits} % (fold)
\label{sec:transistor_circuits}

PN2222

Transistor


% section transistor_circuits (end)


\section{Ethernet Web Server Libraries} % (fold)
\label{sec:ethernet_web_server_libraries}

\footnote{https://github.com/khoih-prog/EthernetWebServer\_STM32}



% section ethernet_web_server_libraries (end)

\section{Digital Signal Processing} % (fold)
\label{sec:digital_signal_processing}

\footnote{http://www.emcu.it/STM32F4xx/STM32F4-Library/STM32F4-Library.html}




% section digital_signal_processing (end)


\section{Secure Digital Block Devices} % (fold)
\label{sec:secure_digital_block_devices}

%\footnote{https://github.com/Ralim/stm32-libraries}

% section secure_digital_block_devices (end)


\section{Home Made RADAR} % (fold)
\label{sec:home_made_radar}


%\footnote{https://os.mbed.com/users/vhx/code/Nucleo\_radar/}

% section home_made_radar (end)

\section{Registering the Serial Number} % (fold)
%\label{sec:registering_the_serial_number}

%\footnote{https://forums.mbed.com/t/accessing-device-serial-number-stm32f4xx-chips-for-example/8120}

% section registering_the_serial_number (end)


\section{Multiplexed LED Multi-Thread} % (fold)
\label{sec:multiplexed_led_multi_thread}

The original work for this example comes from \cite{Ibrahim-ARM-based-Microcontrollers}.  The value in this exercise exists in the multi-thread operations.   We use this lesson to construct classes that inherently use threads to gather information.

% section multiplexed_led_multi_thread (end)

\end{document}
